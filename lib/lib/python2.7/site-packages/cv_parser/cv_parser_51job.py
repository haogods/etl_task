#!/usr/bin/env python
# coding=utf-8

import sys,re,codecs
from bs4 import BeautifulSoup
from urllib2 import urlopen
from collections import OrderedDict
from base import CvTopParser
import os
reload(sys)
sys.setdefaultencoding('utf-8')


class CvParser51Job(CvTopParser):
    """
    对51job的简历进行解析
    """
    def __init__(self):


        CvTopParser.__init__(self)

        self.result = OrderedDict()
        self.PAY = re.compile(u"(\d+[\s\-])?\d+元")
        self.UPDATETIME = re.compile("(更新日期|更新时间)[:：\s](\d{4}.\d{2}.\d{2})")
        self.ADDR = re.compile(u"居住地[：:\s](\S+)")
        self.JOB_START = re.compile(u"(\d+.\d+?)--")
        self.JOB_END = re.compile(u"--(\d+.\d+)")
        self.JOB_DURATION = re.compile(u"\[(.+?)\]")
        self.INC_SCALE = re.compile(u"\d+-\d+人|\d+人[以上下]?")
        self.INC_NAME = re.compile(u"[：:>](\S+?)[\(\[【\r\n ]")
        self.JOB_DEPARTMENT = re.compile(u"部门[:\s：](\S+?)",re.S)
        self.PROJ_NAME = re.compile(u"[:：](\S+?$)")
        


    def preprocess(self,htmlContent=None,fname=None,url=None):
        if url!=None:
            self.html= urlopen(url).read().decode('utf-8')
        elif htmlContent:
            self.html = htmlContent
        elif fname:
            self.html = codecs.open(fname,'rb','gb18030').read()
        else:
            raise Exception("input error")

        if re.search(u"已被(求职者)?删除|无法查看",self.html):
            raise Exception("error: input illegal cv ")

        self.soup = BeautifulSoup(self.html,"lxml")

        
        # 无联系方式无匹配度的
        if self.soup.find("title") and re.search(u"简历ID",self.soup.find("title").get_text()):
            self.HasName = 0
            self.resume = self.soup.find('div',{"id":"divResume"})
            self.topsoup = self.resume.find("table").find("table")
            self.field_list = self.resume.find_all("td","cvtitle")

        # 求职本公司的
        elif self.soup.find("div","titleLineB") and self.soup.find(name="span",text=re.compile(u"应聘职位")):
            self.HasName = 3
            self.job_for_soup = self.soup.find(name="span",text = re.compile(u"应聘职位")).find_previous("table")
            self.topsoup = self.soup.find(name="td",text=re.compile(u"居住地：")).find_previous("table")
            self.resume = self.topsoup.find_parent("table").find_parent("table")
            self.field_list = self.resume.find_all("div","titleLineB")
            if not self.field_list:
                self.field_list = self.resume.find("td","cvtitle")

        # 有应聘职位公司并且显示匹配度的
        elif self.soup.find("div",{"id":"divHead"}):
            self.HasName = 1  
            self.job_for_soup = self.soup.find("div",{"id":"divHead"}).find("td")
            self.topsoup = self.soup.find(name="td",text=re.compile(u"居住地：")).find_parent("table")
            self.resume = self.topsoup.find_parent("table").find_parent("table")
            self.field_list = self.resume.find_all("td","cvtitle")


        # 有联系方式无匹配度的
        elif self.soup.find_all(name="td",text=re.compile(u"E-mail："),limit=10):
            self.HasName = 2   
            find_job_for = self.soup.find(name="span",text=re.compile(u"应聘职位"))
            if find_job_for:
                self.job_for_soup = self.soup.find(name="span",text = re.compile(u"应聘职位")).find_previous("table")
            else:
                self.job_for_soup = BeautifulSoup()

            self.topsoup = self.soup.find(name="td",text=re.compile(u"居住地：")).find_previous("table")
            self.resume = self.topsoup.find_parent("table").find_parent("table")
            self.field_list = self.resume.find_all("td","cvtitle")
            if not self.field_list:
                self.field_list = self.resume.find_all("div","titleLineB")


        self.result.clear()
        self.result["cvFrom"] =  "51job"
        self.result["privateInfo"] = {}
        
        # 求职岗位和企业，自我介绍，兴趣爱好，校园实践，获得荣誉，股票，补贴等各种其他额外信息
        self.result["others"] = {}   
        


    def regular_basic(self):
        """
        解析基本信息
        """

        res = OrderedDict()
        
        find_update_time = self.soup.find("span",{"id":"lblResumeUpdateTime"})
        if find_update_time:
           find_update_time = find_update_time.get_text() 
        elif self.UPDATETIME.search(self.html):
            find_update_time = self.UPDATETIME.search(self.html).group()
        
        base_info = self.topsoup.get_text()
        find_cv_id = self.CV_ID.search(base_info)
        res["cvId"] = find_cv_id.group(1).strip() if find_cv_id else "None"

        
        res["updateTime"] = find_update_time.split(u"：")[-1].strip() if find_update_time else "None"     

        base_info1,base_info2 = "",""

        if self.HasName!=3 and self.topsoup.find_next(name="b",text=u"最近工作"):
            base_info1 = self.topsoup.find_next(name="b",text=re.compile(u"最近工作")).find_parent("table")
            base_info2 = self.topsoup.find_next(name="b",text=re.compile(u"学历")).find_parent("table")
        elif self.topsoup.find_next("div",text=re.compile(u"最近工作")):
            base_info1 = self.topsoup.find_next(name="div",text=re.compile(u"最近工作")).find_next("table")
            base_info2 = base_info1.find_next("table")
        
        if base_info1:
            tokens = base_info1.find_all("tr")
            for token in tokens:
                items = token.find_all("td")
                if len(items)==2:
                    if re.search(u"公.?司",items[0].get_text()):
                        res["nowInc"] = items[1].get_text().strip()
                    elif re.search(u"行.?业",items[0].get_text()):
                        res["nowIndustry"] = items[1].get_text().strip()
                    elif re.search(u"职.?位",items[0].get_text()):
                        res["nowPosition"] = items[1].get_text().strip()

        if base_info2:
            tokens = base_info2.find_all("tr")
            for token in tokens:
                items = token.find_all("td")
                if len(items)==2:
                    if re.search(u"学.?历",items[0].get_text()):
                        res["nowDiploma"] = items[1].get_text().strip()
                    elif re.search(u"专.?业",items[0].get_text()):
                        res["recentMajorName"] = items[1].get_text().strip()
                    elif re.search(u"学.?校",items[0].get_text()):
                        res["recentSchName"] = items[1].get_text().strip()


        find_sex = self.SEX.search(base_info)
        res["gender"]= find_sex.group() if find_sex else "0"

        find_age =  self.AGE.search(base_info)
        res["age"] = find_age.group() if find_age else "0"
       
        find_dob = self.DOB.search(base_info)
        res["dob"] = find_dob.group(1) if find_dob else "None"

       
        try:
            res["nowWorkAge"] = self.topsoup.find("span","blue").find("b").get_text().split(u"|")[0] 
        except:
            res["nowWorkAge"] = self.topsoup.find("span","blue1").find("b").get_text().split(u"|")[0] 

        if not re.search(u"经验|在读|应届|年",res["nowWorkAge"]):
            res["nowWorkAge"] = "None"
        
        
        if "nowDiploma" not in res:
            find_degree = self.DEGREE.search(base_info)
            res["nowDiploma"] = find_degree.group() if find_degree else "None"

        find_marriage = self.MARRIAGE.search(base_info)
        res["marriage"] = find_marriage.group() if find_marriage else "None"
        

        find_politic = self.POLITIC.search(base_info)
        res["nowPolistatus"] = find_politic.group() if find_politic else u"群众"

        #　居住地和户口
        items = self.topsoup.find_all("td",limit=8)
        for item in items:
            if re.search(u"居住地",item.get_text()) and item.find_next_sibling("td"):
                res["nowAddress"] = item.find_next_sibling("td").get_text().strip()
            elif re.search(u"户.{0,3}口",item.get_text()) and item.find_next_sibling("td"):
                res["nowHukou"] = item.find_next_sibling("td").get_text().strip()
            elif re.search(u"地.址",item.get_text()) and item.find_next_sibling("td"):
                res["nowAddressDetail"] = item.find_next_sibling("td").get_text().strip()

        find_height = self.HEIGHT.search(base_info)
        res["height"] = find_height.group(1) if find_height else "None"
        
        if base_info2:
            find_benefit = base_info2.find_next("table").find_next("td",text=re.compile(u"基本工资|目前薪资"))
            if find_benefit:
                tmpsoup = find_benefit.find_previous("table")
                items = tmpsoup.find_all("td")
                for item in items:
                    # 基本工资等福利信息
                    if re.search(u"工资|薪资",item.get_text()):
                        res["nowSalary"] = re.sub("\s+","",item.find_next_sibling("td").get_text().strip())

                    elif re.search(u"补.?贴",item.get_text()):
                        self.result["others"]["subsidy"] = item.find_next_sibling("td").get_text().strip()

                    elif re.search(u"奖.?金",item.get_text()):
                        self.result["others"]["bonus"] = item.find_next_sibling("td").get_text().strip()

                    elif re.search(u"股.?票",item.get_text()):
                        self.result["others"]["stock"] = item.find_next_sibling("td").get_text().strip()

        find_oversea = self.OVER_SEA.search(base_info)
        res["overSea"] = "1" if find_oversea else "None"
        
        self.result['baseInfo'] =  res


    # 求职意向
    def regular_expect(self):

        res = OrderedDict()

        soup = ""
        for field in self.field_list:
            
            if re.search(u"求职意向",field.get_text()):
                if self.HasName==1:
                    soup = field.find_next("table")
                else:
                    soup = field.find_previous("table")
                break

        if soup:
            rows = soup.find_all("tr")
            for item in rows:
                if not item.find("td"):
                    continue
                if re.search(u"目标地",item.find("td").get_text()):
                    res["expLocations"] = item.find("td").find_next().get_text()

                elif re.search(u"月薪|薪资|工资|薪酬",item.find("td").get_text()):
                    res["expSalary"] = self.CLEAN_TEXT.sub("",item.find("td").find_next().get_text())

                elif re.search(u"目前状况|求职状态",item.find("td").get_text()):
                    res["workStatus"] = item.find("td").find_next().get_text()

                elif re.search(u"工作性|目标性",item.find("td").get_text()):
                    res["expJobTypes"] = item.find("td").find_next().get_text()

                elif re.search(u"希望行业|期望行业",item.find("td").get_text()):
                    res["expIndustrys"] = item.find("td").find_next().get_text()

                elif re.search(u"岗位|职[业位]",item.find("td").get_text()):
                    res["expPositions"] = item.find("td").find_next().get_text()

                elif re.search(u"到岗时间",item.find("td").get_text()):
                    res["dutyTime"] = item.find("td").find_next().get_text().strip()

                elif re.search(u"勿推荐|不要推荐",item.find("td").get_text()):
                    res["ignoreIncs"] = item.find("td").find_next().get_text().strip()

                elif re.search(u"职能",item.find("td").get_text()):
                    res["expJobCates"] = item.find("td").find_next().get_text().strip()

        self.result['jobExp'] = res




    # 教育经历
    def regular_educate(self):

        soup = ""
        for field in self.field_list:
            if re.search(u"教育经历",field.get_text()):
                soup = field.find_next("table")
                break
        res = []
        if soup:
            rows = soup.find_all("tr")
            id = 1
            for item in rows:
                tokens =[ token.get_text().strip() for token in  item.find_all("td") if len(token.get_text())>1]
                tmp = {}
                if len(tokens)==4:
                    tmp["itemId"] = str(id)
                    tmp["eduStart"] = self.clean_edu_time(tokens[0].split("-")[0])
                    tmp["eduEnd"] = self.clean_edu_time(tokens[0].split("-")[-1])
                    tmp["schName"] = tokens[1]
                    tmp["majorName"] = tokens[2]
                    tmp["eduDiploma"] = tokens[3]
                    id += 1
                    res.append(tmp)

        if res:
            # 基本信息中的最高学历学校，专业
            self.result["baseInfo"]["recentSchName"] = res[0]["schName"]
            self.result["baseInfo"]["recentMajorName"] = res[0]["majorName"]
        self.result['eduList'] = res




    #　工作经历
    def regular_workexp(self):
        
        soup = ""
        for field in self.field_list:
            if re.search(u"工作经",field.get_text()):
                soup = field.find_next("table")
                break

        res = []

        if soup:
            rows = soup.find_all("tr")
            id = 1
            tokens,tmp = [],[]
            for item in rows:
                if item.find("hr"):
                    tokens.append(tmp)
                    tmp = []
                    continue
                else:
                    tmp.append(item)
            if tmp:
                tokens.append(tmp)
                
            for token in tokens:
                tmp = {}
                if len(token)>2:
                    tmp["itemId"] = str(id)
                    job_title = re.sub(u"[\s\r\n　]","",token[0].find("td").get_text())
                    tmp["jobStart"] = self.clean_edu_time(self.JOB_START.search(job_title).group(1)) if self.JOB_START.search(job_title) else job_title[:6]
                    tmp["jobEnd"] = self.clean_edu_time(self.JOB_END.search(job_title).group(1)) if self.JOB_END.search(job_title) else "None"
                    tmp["jobDuration"] = self.JOB_DURATION.search(job_title).group(1).strip() if self.JOB_DURATION.search(job_title) else "None"

                    tmp["incEmployee"] = self.INC_SCALE.search(job_title).group().strip() if self.INC_SCALE.search(job_title) else "None"           
                    
                    if len(token)>3:
                        tmp["jobDesc"] = token[3].get_text().strip()
                        
                    if job_title:
                        if token[0].find("td").find("b") and not re.search(u"年|月",job_title):
                            tmp["incName"] = token[0].find("td").find("b").get_text().strip() 
                        else:
                            tmp["incName"] = self.INC_NAME.search(job_title).group(1).strip() if self.INC_NAME.search(job_title) else "None"

                        if re.search(u"所属行业",token[1].get_text()):
                            tmp["incIndustrys"] =  token[1].find_all("td")[-1].get_text().strip()
                        else:
                            tmp["jobPosition"] = token[1].find_all("td")[-1].get_text().strip()

                        tmp["jobDesc"] = token[-1].find_all("td")[-1].get_text().strip()

                        jobTagItem = token[2].find_all("td")

                        if len(jobTagItem)==2:
                            tmp["jobPosition"] = jobTagItem[1].get_text().strip()
                            tmp["jobDepartment"] = jobTagItem[0].get_text().strip()
                        elif len(jobTagItem)==3:
                            tmp["jobPosition"] = jobTagItem[1].get_text().strip()
                            tmp["jobDepartment"] = jobTagItem[0].get_text().strip()
                            tmp["jobSalary"] = jobTagItem[2].get_text().strip()

                    else:
                        if token[0].find("td").find('b'):
                            tmp["incName"] = token[0].find("td").find("b").get_text().strip()

                        if re.search(u"职位名称",token[1].get_text()):
                            tmp["jobPosition"] = token[1].find("td").find("b").get_text().strip()
                            tmp["jobDepartment"] = self.JOB_DEPARTMENT.search(token[1].find('td').get_text()).group(1) if self.JOB_DEPARTMENT.search(token[1].find("td").get_text()) else "None"
                        
                        if re.search(u"行业",token[2].get_text()):
                            tmp["incIndustrys"] = token[2].find("td").get_text().strip()[3:]
                        


                    id += 1
                    res.append(tmp)
       
        self.result['jobList'] = res


    # 语言技能
    def regular_language(self):

        
        soup = ""
        for field in self.field_list:
            if re.search(u"语言.?能.?",field.get_text()):
                soup = field.find_next("table")
                if soup and soup.find_all("table"):
                    soup = soup.find_all("table")[-1]
                break

        res = []
        id = 1
        if soup:
            rows = soup.find_all("tr") 
            for item in rows:
                tokens = [ i.get_text() for i in item.find_all("td") if i]
                if len(tokens)!=2:
                    tokens = re.split(u"[:：]",item.get_text(),maxsplit=1)
                if not len(tokens)==2:
                    tokens = re.split(u"[（\(]",item.get_text())
                if len(tokens)==2:
                    tmp = {}
                    tmp["itemId"] = str(id)
                    tmp["languageName"] = re.sub(u"[\s+：:　]","",tokens[0]).split("（")[0]
                    tmp["languageLevel"] = re.sub(u"[\s+　]","",tokens[1])
                    res.append(tmp)
                    id += 1

        self.result["languageList"] = res


    #　证书
    def regular_cert(self):
        

        soup =""
        for field in self.field_list:
            if field and re.search(u"证书",field.get_text()):
                soup = field.find_next("table")
                break

        res = []
        id = 1
        if soup:
            items = soup.find_all("tr") 
            for item in items:
                tokens = item.find_all("td")
                if len(tokens)<2:continue
                tmp = {}
                tmp["itemId"] = str(id)
                tmp["certTime"] = self.clean_edu_time(tokens[0].get_text())
                tmp["certName"] = tokens[1].get_text().strip()
                cert_str = tmp["certName"]
                find_level = self.CERT_LEVEL.search(cert_str)
                if find_level:
                    tmp["certLevel"] = find_level.group()
                    tmp["certName"] = tmp["certName"]
                elif len(tokens)>2:
                    tmp["certLevel"] = tokens[2].get_text().strip()

                if tmp:
                    res.append(tmp)
                    id += 1

        self.result["certList"] = res
   
    
    # 技能
    def regular_skill(self):
        """
        技能模块
        """

        soup = ""
        for field in self.field_list:
            if re.search(u"技能",field.get_text()):
                soup = field.find_next("table")
                if soup and soup.find_all("table"):
                    soup = soup.find_all("table")[-1]
                break

        res = []
        id = 1
        if soup:
#            items = soup.find_all("table",limit=4)[-1].find_all("tr") if soup.find("table") else []
            items = soup.find_all("tr")
            for item in items:
                tokens = [token.get_text() for token in item.find_all("td")]
                if len(tokens)<2 or re.search(u"名称",tokens[0]):continue
                tmp = {}
                tmp["itemId"] = str(id)
                tmp["skillName"] = tokens[0].strip().lower()
                tmp["skillLevel"] = tokens[1].strip()

                if len(tokens)>2:
                    tmp["skillDuration"] = tokens[2].strip()
                else:
                    find_duration = re.search("\d+月|[半一二三四五六七八九十\d]年",item.get_text())
                    tmp["skillDuration"] = find_duration.group() if find_duration else "None"

                if tmp:
                    res.append(tmp)
                    id += 1


        self.result['skillList'] = res

     
    #　项目经验
    def regular_project(self):

        soup = ""
        for field in self.field_list:
            if re.search(u"项目经.",field.get_text()):
                soup = field.find_next("table")
                break

        res = []
        id = 1
        if soup:
            items = soup.find_all("tr") 

            tokens,tmpitem =[],[]
            for item in items:
                if item.find("hr"):
                    tokens.append(tmpitem)
                    tmpitem = []
                    continue
                elif item:
                    tmpitem.append(item)
            if tmpitem:
                tokens.append(tmpitem)


            for token in tokens:

                # 解析第一行项目标题
                title_str = re.sub(u"[\s\r\n　]","",token[0].get_text())
                tmp = {}
                tmp["itemId"] = str(id)
                tmp["proStart"] = self.clean_edu_time(self.JOB_START.search(title_str).group(1)) if self.JOB_START.search(title_str) else "None" 
                tmp["proEnd"] = self.clean_edu_time(self.JOB_END.search(title_str).group(1)) if self.JOB_END.search(title_str) else "None" 
                tmp["proName"] = re.sub("\s+","",self.PROJ_NAME.search(title_str).group(1)) if self.PROJ_NAME.search(title_str) else title_str
                
                #　解析剩余行标签
                field_list = [ item.find("td") for item in token[1:] ]
                for field in field_list:
                    field_str = field.get_text().strip()

                    if re.search(u"软件环境",field_str):
                        tmp["softwareEnv"] = field.find_next("td").get_text()
                    elif re.search(u"硬件环境",field_str):
                        tmp["hardwareEnv"] = field.find_next("td").get_text()
                    elif re.search(u"开发工具",field_str):
                        tmp["devTool"] = field.find_next("td").get_text()
                    elif re.search(u"项目描述",field_str):
                        tmp["proDesc"] = field.find_next("td").get_text()
                    elif re.search(u"责任描述",field_str):
                        tmp["proDuty"] = field.find_next("td").get_text()

                if tmp:
                    res.append(tmp)
                    id += 1

        self.result['proList'] = res




    def regular_train(self):

        soup = ""
        for field in self.field_list:
            if re.search(u"培训经.",field.get_text()):
                soup = field.find_next("table")
                break

        res = []
        id = 1
        if soup:
            items = soup.find_all("tr") 
            for item in items:
                tokens =[item.get_text() for item in item.find_all("td") if len(item.get_text())>1]
                if len(tokens)<3:continue
                tmp = {}
                tmp["itemId"] = str(id)
                tmp["trainStart"] = self.clean_edu_time(tokens[0].split(u'-')[0])
                tmp["trainEnd"] = self.clean_edu_time(tokens[0].split(u"-")[-1])
                tmp["trainAgency"] = tokens[1].strip()
                tmp["trainTitle"] = tokens[-1].strip()
                res.append(tmp)
                id += 1

        self.result["trainList"] = res

    
    def regular_private(self):
        """
        身份证号，联系电话等隐私信息
        """
        
        res = {}
        base_info = self.topsoup.get_text()
        find_phone = self.PHONE.search(base_info)
        find_email = self.EMAIL.search(base_info)
        find_qq = self.QQ.search(base_info)
        find_idNum = self.IDNUM.search(base_info)

        userName = ""

        if self.HasName:
            find_name = self.topsoup.find_previous("tr").find_previous("tr").find("b")
            if not find_name:
                find_name = self.topsoup.find_previous("tr").find_previous("tr").find("strong")
            if find_name and len(find_name.get_text().strip())<5:
                userName = find_name.get_text().strip()
        
        res["userName"] = userName if userName else "None"
        res["phoneNumber"] = find_phone.group(1) if find_phone else "None"
        res["email"] = find_email.group(1) if find_email else "None"
        res["qq"] = find_qq.group(1) if find_qq else "None"
        res["idNumber"] = find_idNum.group(1) if find_idNum else "None"
        
        find_key_word =  self.soup.find("span",text=re.compile(u"简历关键字"))
        key_words = ""
        if find_key_word and find_key_word.find_next("span","rsblue"):
            key_words =  find_key_word.find_next("span","rsblue").get_text()
        elif find_key_word and find_key_word.find_next("td"):
            key_words = find_key_word.find_next("td").get_text()

        if key_words and re.search(u"有|熟悉|经验|强|善于|精通|证",key_words):
            res["keywords"] = key_words.strip().split()

        self.result["privateInfo"] = res



    def regular_other(self):
        
        res = {}
        res["jobPositionFor"] = "None"
        res["jobIncNameFor"] = "None"

        for field in self.field_list:
            if re.search(u"自我介绍|个人简介|亮点|自我评价",field.get_text()):
               res["selfIntro"] = field.find_previous("table").get_text().strip()
            
            elif re.search(u"实践|实习",field.get_text()):
                res["stuPractice"] = re.sub("\s+"," ",field.find_next("table").get_text().strip())
            
            elif re.search(u"校内|校园|社团",field.get_text()):
                res["schoolExp"] = re.sub("\s+"," ",field.find_next("table").get_text().strip())

            elif re.search(u"论文|著作|作品",field.get_text()):
                res["pubWork"] = res.get("otherWork","")+"\n"+self.CLEAN_TEXT.sub(" ",field.find_next("table").get_text().strip())
        
            elif re.search(u"奖项|荣誉",field.get_text()):
                res["gainHoner"] = res.get("otherWork","")+"\n"+self.CLEAN_TEXT.sub(" ",field.find_next("table").get_text().strip())

            elif re.search(u"兴趣|爱好|特长",field.get_text()):
                res["otherHobby"] = res.get("otherHobby","")+"\n"+self.CLEAN_TEXT.sub(" ",field.find_next("table").get_text().strip())
            
            elif re.search(u"其他",field.get_text()):
                res["otherInfo"] = field.find_next("table").get_text().strip()

        if self.HasName==1:
            find_jobPositionName = re.search(u"应聘职位",self.job_for_soup.get_text())
            if find_jobPositionName:
                res["jobPositionFor"] = self.job_for_soup.find_next("span").get_text().strip()

            find_jobIncName = re.search(u"应聘公司",self.job_for_soup.get_text())
            if find_jobIncName:
                res["jobIncNameFor"] = self.job_for_soup.find_next("span").find_next("span").get_text().strip()
            
            find_updateTime = re.search(u"投递时间",self.job_for_soup.get_text())
            if self.result["baseInfo"]["updateTime"]=="None" and find_updateTime:
                self.result["baseInfo"]["updateTime"] = self.job_for_soup.find_next("span").find_next("span").get_text().strip()


        elif self.HasName>1:
            items = self.job_for_soup.find_all("td",limit=6)
            for item in items:
                if re.search(u"应聘职位",item.get_text()):
                    res["jobPositionFor"] = item.find_next_sibling("td").get_text().strip()
                elif re.search(u"应聘公司",item.get_text()):
                    res["jobIncNameFor"] = item.find_next_sibling("td").get_text().strip()
                elif re.search(u"投递时间",item.get_text()):
                    self.result["baseInfo"]["updateTime"] = item.find_next_sibling("td").get_text().strip()
                    break
        res.update(self.result.pop("others",{}))
        self.result["others"] = res


    def parser(self,htmlContent=None,fname=None,url=None):
        self.preprocess(htmlContent,fname,url)
        self.regular_basic()
        self.regular_private()
        self.regular_expect()
        self.regular_educate()
        self.regular_workexp()
        self.regular_skill()
        self.regular_cert()
        self.regular_language()
        self.regular_project()
        self.regular_train()
        self.regular_other()
        return self.result


    
    def output(self):
        res = "\n"
        for k in self.result:
            res += k+":"+"\n"
            if isinstance(self.result[k],dict):
                for kk,vv in self.result[k].iteritems():
                    res += '%1s: %s\n' %( kk,vv )
            elif isinstance(self.result[k],list):
                for i,exp in enumerate(self.result[k]):
                    res+= "%12s\n" % (str(i+1))
                    if isinstance(exp,dict):
                        for kk,vv in exp.iteritems():
                            res += "%22s: %s\n" % (kk,vv)
                    elif isinstance(exp,tuple):
                        for kk in exp:
                            res += '%22s \n'% (kk)
                    res += " "*10+'---'*10+'\n'
            else:
                res += " "*10+"%s\n" % (self.result[k])
        return res




import simplejson as json

if __name__ == "__main__":
    """
    测试
    """
    test = CvParser51Job()

    path = './data/errorcvs/'
    fnames = [ path+fname for fname in os.listdir(path) if fname.startswith("3385")][-200:]

    for i,fname in enumerate(fnames):
        print i+1,'='*20,fname
        htmlContent = codecs.open(fname,'rb','utf-8').read()
        test.parser(htmlContent = htmlContent)
        print(json.dumps(test.result,ensure_ascii=False,indent=4))
